name: Release Pipeline

# Runs ONLY on merge to main - builds, pushes, updates manifests ‚Üí ArgoCD sync
on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and push backend image
  build-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=sha,prefix=main-
            type=raw,value=latest

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build and push frontend image
  build-frontend:
    name: Build & Push Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=sha,prefix=main-
            type=raw,value=latest

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./openluffy-ui/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Update Helm manifests with new image tags ‚Üí triggers ArgoCD sync
  update-manifests:
    name: Update Manifests ‚Üí ArgoCD
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tags in Helm values
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "Updating Helm values with tag: main-${SHORT_SHA}"
          
          # Update backend image tag
          sed -i "s|tag:.*# backend|tag: main-${SHORT_SHA} # backend|g" helm/openluffy/values.yaml
          
          # Update frontend image tag
          sed -i "s|tag:.*# frontend|tag: main-${SHORT_SHA} # frontend|g" helm/openluffy/values.yaml
          
          cat helm/openluffy/values.yaml
          
      - name: Commit and push manifest changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add helm/openluffy/values.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            git commit -m "chore: update image tags to main-${SHORT_SHA} [skip ci]"
            git push
            echo "‚úÖ Manifests updated - ArgoCD will sync automatically"
          fi

  # Release success notification
  release-success:
    name: Release Complete ‚úÖ
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, update-manifests]
    steps:
      - name: Release summary
        run: |
          echo "üè¥‚Äç‚ò†Ô∏è OpenLuffy Release Pipeline Complete"
          echo ""
          echo "‚úÖ Backend image built and pushed"
          echo "‚úÖ Frontend image built and pushed"
          echo "‚úÖ Helm manifests updated"
          echo "‚úÖ ArgoCD will sync automatically"
          echo ""
          echo "Deployment: http://openluffy.local"
